import streamlit as st
import pandas as pd
from streamlit_gsheets import GSheetsConnection
from datetime import datetime
import io

# --- 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô ---

INITIAL_CSV = """Date,‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£,‡∏£‡∏≤‡∏Ñ‡∏≤,‡∏à‡∏≥‡∏ô‡∏ß‡∏ô/‡∏ä‡∏¥‡πâ‡∏ô,‡∏£‡∏ß‡∏°/‡∏ö‡∏≤‡∏ó
2026-01-03,‡πÄ‡∏Ñ‡πâ‡∏Å‡∏ô‡∏°‡∏™‡∏î,50,47,2350
2026-01-03,‡πÄ‡∏Ñ‡πâ‡∏Å‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô,60,12,720
2026-01-03,‡πÄ‡∏Ñ‡πâ‡∏Å 60 ‡∏ö‡∏≤‡∏ó,90,6,540
2026-01-02,‡∏ä‡∏µ‡∏™‡πÄ‡∏Ñ‡πâ‡∏Å,60,0,0
2026-01-02,‡∏Ñ‡∏∏‡∏Å‡∏Å‡∏µ‡πâ‡∏õ‡πä‡∏≠‡∏õ,25,0,0
2026-01-02,‡πÄ‡∏Ñ‡πâ‡∏Å‡∏õ‡πä‡∏≠‡∏õ,75,0,0
2026-01-02,‡∏°‡∏≤‡∏Å‡∏≤‡∏£‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏ï‡∏π‡∏ô,70,5,350
2026-01-02,‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ü‡∏•‡∏Ñ,100,0,0
2026-01-02,‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ü‡∏•‡∏Ñ,100,0,0
2026-01-02,‡∏ä‡πá‡∏≠‡∏Ñ‡∏ö‡∏≠‡∏• 30,30,10,300
2026-01-02,‡∏ä‡πá‡∏≠‡∏Ñ‡∏≠‡∏• 20,0,0,0
2026-01-02,‡∏ä‡∏≤‡∏ä‡∏á‡∏™‡∏î,40,0,0
2026-01-02,cold brew,65,0,0
2026-01-02,‡∏•‡∏≤‡∏ö‡∏π‡∏ö‡∏π‡πâ,159,0,0
2026-01-02,‡∏Ñ‡∏∏‡∏Å‡∏Å‡∏µ‡πâ‡πÄ‡∏ô‡∏¢,39,0,0
2002-01-21,‡πÄ‡∏°‡∏≠‡πÅ‡∏£‡∏á,35,0,0
2026-01-02,‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÄ‡∏Ñ‡πâ‡∏Å 4,35,0,0
2026-01-02,‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÄ‡∏Ñ‡πâ‡∏Å 12‡∏ä‡∏µ‡πâ‡∏ô,65,0,0
2026-01-02,‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÄ‡∏Ñ‡πâ‡∏Å 24,120,0,0
2026-01-02,‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÄ‡∏Ñ‡πâ‡∏Å 36,100,0,0
2026-01-02,‡∏û‡∏£‡∏¥‡∏Å‡∏ó‡∏≠‡∏î,110,0,0
2026-01-02,‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ç‡∏¥‡∏á/‡πÅ‡∏Ñ‡∏£‡πå‡πÅ‡∏ö‡∏£‡πå,79,0,0
2026-01-02,‡∏ñ‡∏∏‡∏á‡∏ú‡πâ‡∏≤ nami,40,0,0
2026-01-02,‡πÅ‡∏Å‡πâ‡∏ß‡∏ô‡πâ‡∏≥‡∏ô‡∏≤‡∏°‡∏¥,0,0,0
2026-01-02,‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ü‡∏•‡∏Ñ,100,0,0
2026-01-02,‡∏≠‡∏∑‡πà‡∏ô‡πÜ,0,0,0
2026-01-02,cake pop,65,0,0
2026-01-02,‡∏Å‡∏∞‡∏ö‡∏≠‡∏Å‡∏ô‡πã‡∏≤,0,0,0
2026-01-02,cake orange,45,0,0"""

def get_current_sheet_name():
    return datetime.now().strftime("%b_%Y")

conn = st.connection("gsheets", type=GSheetsConnection)

def load_data():
    current_sheet = get_current_sheet_name()
    try:
        df = conn.read(worksheet=current_sheet)
        if df.empty: raise ValueError("Empty sheet")
        df['Date'] = pd.to_datetime(df['Date']).dt.date
        return df
    except Exception:
        df = pd.read_csv(io.StringIO(INITIAL_CSV))
        df['Date'] = pd.to_datetime(df['Date'], errors='coerce').dt.date
        df = df.fillna(0)
        return df

# --- 2. ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• ---

st.set_page_config(page_title="‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ç‡∏≠‡∏á Cloud", layout="wide")

st.title("‚òÅÔ∏è ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô (Google Sheets)")
st.caption(f"Sheet ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: {get_current_sheet_name()}")

if 'df' not in st.session_state:
    st.session_state.df = load_data()

# --- ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ---
st.subheader(f"üìù ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤")

# ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á Editor
edited_df = st.data_editor(
    st.session_state.df,
    num_rows="dynamic",
    column_config={
        "Date": st.column_config.DateColumn("‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà", default=datetime.now().date(), format="YYYY-MM-DD"),
        "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£": st.column_config.TextColumn("‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤", required=True),
        "‡∏£‡∏≤‡∏Ñ‡∏≤": st.column_config.NumberColumn("‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏ä‡∏¥‡πâ‡∏ô", min_value=0, format="%.2f"),
        "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô/‡∏ä‡∏¥‡πâ‡∏ô": st.column_config.NumberColumn("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô", min_value=0, step=1),
        "‡∏£‡∏ß‡∏°/‡∏ö‡∏≤‡∏ó": st.column_config.NumberColumn("‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô", disabled=True) # ‡∏ä‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏´‡πâ‡∏≤‡∏°‡πÅ‡∏Å‡πâ ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡πâ
    },
    use_container_width=True,
    key="editor"
)

# --- üî• ‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (Auto Calculation Logic) üî• ---
# ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡∏∞ Rerun ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
cols_needed = ['‡∏£‡∏≤‡∏Ñ‡∏≤', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô/‡∏ä‡∏¥‡πâ‡∏ô']
if all(col in edited_df.columns for col in cols_needed):
    # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡πÉ‡∏´‡∏°‡πà (‡∏£‡∏≤‡∏Ñ‡∏≤ * ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô)
    calculated_total = edited_df['‡∏£‡∏≤‡∏Ñ‡∏≤'] * edited_df['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô/‡∏ä‡∏¥‡πâ‡∏ô']
    
    # ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà ‡∏ï‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    # (‡πÉ‡∏ä‡πâ fillna(0) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô error ‡∏Å‡∏£‡∏ì‡∏µ‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á)
    if not calculated_total.equals(edited_df['‡∏£‡∏ß‡∏°/‡∏ö‡∏≤‡∏ó'].fillna(0)):
        edited_df['‡∏£‡∏ß‡∏°/‡∏ö‡∏≤‡∏ó'] = calculated_total
        st.session_state.df = edited_df
        st.rerun() # üîÑ ‡∏™‡∏±‡πà‡∏á‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏±‡∏ô‡∏ó‡∏µ

# --- ‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì ---

st.divider()

# --- ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î (Metrics) ---
# ‡∏¢‡πâ‡∏≤‡∏¢‡∏°‡∏≤‡πÑ‡∏ß‡πâ‡∏Ç‡πâ‡∏≤‡∏á‡∏•‡πà‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏™‡∏°‡∏≠
st.subheader("üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (Real-time)")
col1, col2, col3 = st.columns(3)

today = datetime.now().date()
current_df = edited_df # ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç

daily_sales = current_df[current_df['Date'] == today]['‡∏£‡∏ß‡∏°/‡∏ö‡∏≤‡∏ó'].sum() if '‡∏£‡∏ß‡∏°/‡∏ö‡∏≤‡∏ó' in current_df.columns else 0
monthly_sales = current_df['‡∏£‡∏ß‡∏°/‡∏ö‡∏≤‡∏ó'].sum() if '‡∏£‡∏ß‡∏°/‡∏ö‡∏≤‡∏ó' in current_df.columns else 0
items_today = current_df[current_df['Date'] == today]['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô/‡∏ä‡∏¥‡πâ‡∏ô'].sum() if '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô/‡∏ä‡∏¥‡πâ‡∏ô' in current_df.columns else 0

col1.metric("‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (‡∏ö‡∏≤‡∏ó)", f"{daily_sales:,.2f}")
col2.metric("‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ (‡∏ö‡∏≤‡∏ó)", f"{monthly_sales:,.2f}")
col3.metric("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏¥‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ", f"{items_today:,.0f} ‡∏ä‡∏¥‡πâ‡∏ô")

# ‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô Cloud
if st.button("‚òÅÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô Google Sheets", type="primary"):
    with st.spinner('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏∂‡πâ‡∏ô Cloud...'):
        st.session_state.df = edited_df
        conn.update(worksheet=get_current_sheet_name(), data=edited_df)
        st.success("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô Google Sheets ‡πÅ‡∏•‡πâ‡∏ß")

st.divider()

# ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô
st.subheader("üìÖ ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô")
if not current_df.empty and 'Date' in current_df.columns:
    summary_by_date = current_df.groupby('Date')[['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô/‡∏ä‡∏¥‡πâ‡∏ô', '‡∏£‡∏ß‡∏°/‡∏ö‡∏≤‡∏ó']].sum().sort_index(ascending=False)
    st.dataframe(summary_by_date)
