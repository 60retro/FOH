import streamlit as st
import pandas as pd
from streamlit_gsheets import GSheetsConnection
from datetime import datetime
import io
import time

# --- 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö (SETUP) ---
st.set_page_config(
    page_title="Nami POS (Fix)",
    layout="wide",
    page_icon="üç∞"
)

# ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
INITIAL_CSV = """Date,‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£,‡∏£‡∏≤‡∏Ñ‡∏≤,‡∏à‡∏≥‡∏ô‡∏ß‡∏ô/‡∏ä‡∏¥‡πâ‡∏ô,‡∏£‡∏ß‡∏°/‡∏ö‡∏≤‡∏ó
2026-01-01,‡πÄ‡∏Ñ‡πâ‡∏Å‡∏ô‡∏°‡∏™‡∏î,50,0,0
2026-01-01,‡πÄ‡∏Ñ‡πâ‡∏Å‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô,60,0,0
2026-01-01,‡πÄ‡∏Ñ‡πâ‡∏Å 60 ‡∏ö‡∏≤‡∏ó,90,0,0
2026-01-01,‡∏ä‡∏µ‡∏™‡πÄ‡∏Ñ‡πâ‡∏Å,60,0,0
2026-01-01,‡∏Ñ‡∏∏‡∏Å‡∏Å‡∏µ‡πâ‡∏õ‡πä‡∏≠‡∏õ,25,0,0
2026-01-01,‡πÄ‡∏Ñ‡πâ‡∏Å‡∏õ‡πä‡∏≠‡∏õ,75,0,0
2026-01-01,‡∏°‡∏≤‡∏Å‡∏≤‡∏£‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏ï‡∏π‡∏ô,70,0,0
2026-01-01,‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ü‡∏•‡∏Ñ,100,0,0
2026-01-01,‡∏ä‡πá‡∏≠‡∏Ñ‡∏ö‡∏≠‡∏• 30,30,0,0
2026-01-01,‡∏ä‡πá‡∏≠‡∏Ñ‡∏ö‡∏≠‡∏• 20,20,0,0
2026-01-01,‡∏ä‡∏≤‡∏ä‡∏á‡∏™‡∏î,40,0,0
2026-01-01,cold brew,65,0,0
2026-01-01,‡∏•‡∏≤‡∏ö‡∏π‡∏ö‡∏π‡πâ,159,0,0
2026-01-01,‡∏Ñ‡∏∏‡∏Å‡∏Å‡∏µ‡πâ‡πÄ‡∏ô‡∏¢,39,0,0
2026-01-01,‡πÄ‡∏°‡∏≠‡πÅ‡∏£‡∏á,35,0,0
2026-01-01,‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÄ‡∏Ñ‡πâ‡∏Å 4,35,0,0
2026-01-01,‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÄ‡∏Ñ‡πâ‡∏Å 12‡∏ä‡∏µ‡πâ‡∏ô,65,0,0
2026-01-01,‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÄ‡∏Ñ‡πâ‡∏Å 24,120,0,0
2026-01-01,‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÄ‡∏Ñ‡πâ‡∏Å 36,100,0,0
2026-01-01,‡∏û‡∏£‡∏¥‡∏Å‡∏ó‡∏≠‡∏î,110,0,0
2026-01-01,‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ç‡∏¥‡∏á/‡πÅ‡∏Ñ‡∏£‡πå‡πÅ‡∏ö‡∏£‡πå,79,0,0
2026-01-01,‡∏ñ‡∏∏‡∏á‡∏ú‡πâ‡∏≤ nami,40,0,0
2026-01-01,‡πÅ‡∏Å‡πâ‡∏ß‡∏ô‡πâ‡∏≥‡∏ô‡∏≤‡∏°‡∏¥,0,0,0
2026-01-01,‡∏≠‡∏∑‡πà‡∏ô‡πÜ,0,0,0
2026-01-01,cake pop,65,0,0
2026-01-01,‡∏Å‡∏∞‡∏ö‡∏≠‡∏Å‡∏ô‡πã‡∏≤,0,0,0
2026-01-01,cake orange,45,0,0"""

conn = st.connection("gsheets", type=GSheetsConnection)

def get_current_sheet_name():
    return datetime.now().strftime("%b_%Y")

def get_menu_dict():
    """‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏Ñ‡∏≤‡∏à‡∏≤‡∏Å CSV"""
    try:
        df = pd.read_csv(io.StringIO(INITIAL_CSV))
        menu = df[['‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', '‡∏£‡∏≤‡∏Ñ‡∏≤']].drop_duplicates(subset='‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£')
        return dict(zip(menu['‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'], menu['‡∏£‡∏≤‡∏Ñ‡∏≤']))
    except:
        return {}

def load_data():
    """‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö Data Type ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"""
    try:
        df = conn.read(worksheet=get_current_sheet_name())
        if df.empty:
            df = pd.read_csv(io.StringIO(INITIAL_CSV)).head(0)
    except:
        df = pd.read_csv(io.StringIO(INITIAL_CSV)).head(0)

    # --- ‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÑ‡∏î‡πâ ---
    # ‡∏ñ‡πâ‡∏≤‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô 0
    df['‡∏£‡∏≤‡∏Ñ‡∏≤'] = pd.to_numeric(df['‡∏£‡∏≤‡∏Ñ‡∏≤'], errors='coerce').fillna(0).astype(float)
    df['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô/‡∏ä‡∏¥‡πâ‡∏ô'] = pd.to_numeric(df['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô/‡∏ä‡∏¥‡πâ‡∏ô'], errors='coerce').fillna(0).astype(int)
    df['‡∏£‡∏ß‡∏°/‡∏ö‡∏≤‡∏ó'] = pd.to_numeric(df['‡∏£‡∏ß‡∏°/‡∏ö‡∏≤‡∏ó'], errors='coerce').fillna(0).astype(float)
    
    # ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
    df['Date'] = pd.to_datetime(df['Date'], errors='coerce').dt.date
    
    # ‡∏ñ‡πâ‡∏≤‡∏ß‡∏±‡∏ô‡πÑ‡∏´‡∏ô‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÉ‡∏´‡πâ‡πÉ‡∏™‡πà‡∏ß‡∏±‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    df['Date'] = df['Date'].fillna(datetime.now().date())
    
    return df

# ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
if 'df' not in st.session_state:
    st.session_state.df = load_data()

if 'menu_items' not in st.session_state:
    st.session_state.menu_items = get_menu_dict()

# --- 2. ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (UI) ---
st.title("üç∞ Nami POS (‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô)")

# ‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Tab
tab1, tab2, tab3 = st.tabs(["üõí ‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤", "üìä ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î", "‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏•‡∏ö ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£"])

# ==========================================
# TAB 1: ‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Cashier)
# ==========================================
with tab1:
    with st.container(border=True):
        st.subheader("‚ûï ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà")
        
        c1, c2, c3, c4 = st.columns([2, 3, 2, 2])
        
        # 1. ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
        with c1:
            pick_date = st.date_input("‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà", value=datetime.now().date())
            
        # 2. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        with c2:
            menu_list = ["-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ --"] + list(st.session_state.menu_items.keys())
            item_name = st.selectbox("‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£", menu_list)
            
            # ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
            default_price = 0.0
            if item_name != "-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ --":
                default_price = float(st.session_state.menu_items.get(item_name, 0))

        # 3. ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô
        with c3:
            price = st.number_input("‡∏£‡∏≤‡∏Ñ‡∏≤", value=default_price, min_value=0.0, step=1.0)
        with c4:
            qty = st.number_input("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô", value=1, min_value=1, step=1)
            
        # ‡πÅ‡∏™‡∏î‡∏á‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
        total = price * qty
        st.info(f"üí∞ ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ: **{total:,.0f} ‡∏ö‡∏≤‡∏ó**")

        if st.button("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (Save)", type="primary", use_container_width=True):
            if item_name == "-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ --":
                st.error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö")
            else:
                new_row = pd.DataFrame([{
                    'Date': pick_date,
                    '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£': item_name,
                    '‡∏£‡∏≤‡∏Ñ‡∏≤': float(price),
                    '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô/‡∏ä‡∏¥‡πâ‡∏ô': int(qty),
                    '‡∏£‡∏ß‡∏°/‡∏ö‡∏≤‡∏ó': float(total)
                }])
                
                # ‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                st.session_state.df = pd.concat([new_row, st.session_state.df], ignore_index=True)
                
                # ‡∏™‡πà‡∏á‡∏Ç‡∏∂‡πâ‡∏ô Cloud
                try:
                    conn.update(worksheet=get_current_sheet_name(), data=st.session_state.df)
                    st.success(f"‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å '{item_name}' ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!")
                    time.sleep(1)
                    st.rerun() # ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤
                except Exception as e:
                    st.error(f"Error: {e}")

# ==========================================
# TAB 2: ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î (Dashboard)
# ==========================================
with tab2:
    df_show = st.session_state.df.copy()
    
    if not df_show.empty:
        today = datetime.now().date()
        
        # ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
        # ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå Date ‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏ô‡∏¥‡∏î date ‡∏à‡∏£‡∏¥‡∏á‡πÜ
        df_show['Date'] = pd.to_datetime(df_show['Date']).dt.date 
        
        sales_today = df_show[df_show['Date'] == today]['‡∏£‡∏ß‡∏°/‡∏ö‡∏≤‡∏ó'].sum()
        qty_today = df_show[df_show['Date'] == today]['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô/‡∏ä‡∏¥‡πâ‡∏ô'].sum()
        sales_month = df_show['‡∏£‡∏ß‡∏°/‡∏ö‡∏≤‡∏ó'].sum()
        
        c1, c2, c3 = st.columns(3)
        c1.metric("‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ", f"{sales_today:,.0f} ‡∏ø")
        c2.metric("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏¥‡πâ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ", f"{qty_today:,.0f} ‡∏ä‡∏¥‡πâ‡∏ô")
        c3.metric("‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô", f"{sales_month:,.0f} ‡∏ø")
        
        st.divider()
        st.subheader("üìÖ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ")
        st.dataframe(df_show[df_show['Date'] == today], use_container_width=True, hide_index=True)
    else:
        st.info("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö")

# ==========================================
# TAB 3: ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Edit / Delete)
# ==========================================
with tab3:
    st.subheader("üõ†Ô∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏•‡∏ö)")
    st.warning("‚ö†Ô∏è ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ: ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Cloud")

    # ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
    edited_df = st.data_editor(
        st.session_state.df,
        num_rows="dynamic", # ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏ö ‡πÅ‡∏ñ‡∏ß‡πÑ‡∏î‡πâ
        column_config={
            "Date": st.column_config.DateColumn("‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà", format="YYYY-MM-DD"),
            "‡∏£‡∏ß‡∏°/‡∏ö‡∏≤‡∏ó": st.column_config.NumberColumn("‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏¥‡∏ô (‡∏£‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì)", disabled=True) # ‡∏•‡πá‡∏≠‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏ß‡πâ ‡∏Å‡∏±‡∏ô‡∏á‡∏á
        },
        use_container_width=True,
        key="main_editor"
    )
    
    # ‡∏õ‡∏∏‡πà‡∏° Save ‡∏¢‡∏±‡∏Å‡∏©‡πå
    if st.button("üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç + ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡πÉ‡∏´‡∏°‡πà", type="primary", use_container_width=True):
        # 1. ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏∏‡∏Å‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î (‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏¢‡∏≠‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏î‡∏¥‡∏ô)
        edited_df['‡∏£‡∏≤‡∏Ñ‡∏≤'] = edited_df['‡∏£‡∏≤‡∏Ñ‡∏≤'].astype(float)
        edited_df['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô/‡∏ä‡∏¥‡πâ‡∏ô'] = edited_df['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô/‡∏ä‡∏¥‡πâ‡∏ô'].astype(int)
        edited_df['‡∏£‡∏ß‡∏°/‡∏ö‡∏≤‡∏ó'] = edited_df['‡∏£‡∏≤‡∏Ñ‡∏≤'] * edited_df['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô/‡∏ä‡∏¥‡πâ‡∏ô']
        
        # 2. Reset Index (‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß index ‡πÅ‡∏´‡∏ß‡πà‡∏á)
        edited_df = edited_df.reset_index(drop=True)
        
        # 3. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏Ç‡πâ‡∏≤ Session
        st.session_state.df = edited_df
        
        # 4. ‡∏™‡πà‡∏á‡∏Ç‡∏∂‡πâ‡∏ô Cloud
        try:
            conn.update(worksheet=get_current_sheet_name(), data=edited_df)
            st.success("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!")
            time.sleep(1)
            st.rerun() # ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÉ‡∏´‡πâ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
        except Exception as e:
            st.error(f"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: {e}")
