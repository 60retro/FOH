import streamlit as st
import pandas as pd
from streamlit_gsheets import GSheetsConnection
from datetime import datetime
import io

# --- 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô ---

INITIAL_CSV = """Date,‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£,‡∏£‡∏≤‡∏Ñ‡∏≤,‡∏à‡∏≥‡∏ô‡∏ß‡∏ô/‡∏ä‡∏¥‡πâ‡∏ô,‡∏£‡∏ß‡∏°/‡∏ö‡∏≤‡∏ó
2026-01-03,‡πÄ‡∏Ñ‡πâ‡∏Å‡∏ô‡∏°‡∏™‡∏î,50,47,2350
2026-01-03,‡πÄ‡∏Ñ‡πâ‡∏Å‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô,60,12,720
2026-01-03,‡πÄ‡∏Ñ‡πâ‡∏Å 60 ‡∏ö‡∏≤‡∏ó,90,6,540
2026-01-02,‡∏ä‡∏µ‡∏™‡πÄ‡∏Ñ‡πâ‡∏Å,60,0,0
2026-01-02,‡∏Ñ‡∏∏‡∏Å‡∏Å‡∏µ‡πâ‡∏õ‡πä‡∏≠‡∏õ,25,0,0
2026-01-02,‡πÄ‡∏Ñ‡πâ‡∏Å‡∏õ‡πä‡∏≠‡∏õ,75,0,0
2026-01-02,‡∏°‡∏≤‡∏Å‡∏≤‡∏£‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏ï‡∏π‡∏ô,70,5,350
2026-01-02,‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ü‡∏•‡∏Ñ,100,0,0
2026-01-02,‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ü‡∏•‡∏Ñ,100,0,0
2026-01-02,‡∏ä‡πá‡∏≠‡∏Ñ‡∏ö‡∏≠‡∏• 30,30,10,300
2026-01-02,‡∏ä‡πá‡∏≠‡∏Ñ‡∏≠‡∏• 20,0,0,0
2026-01-02,‡∏ä‡∏≤‡∏ä‡∏á‡∏™‡∏î,40,0,0
2026-01-02,cold brew,65,0,0
2026-01-02,‡∏•‡∏≤‡∏ö‡∏π‡∏ö‡∏π‡πâ,159,0,0
2026-01-02,‡∏Ñ‡∏∏‡∏Å‡∏Å‡∏µ‡πâ‡πÄ‡∏ô‡∏¢,39,0,0
2002-01-21,‡πÄ‡∏°‡∏≠‡πÅ‡∏£‡∏á,35,0,0
2026-01-02,‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÄ‡∏Ñ‡πâ‡∏Å 4,35,0,0
2026-01-02,‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÄ‡∏Ñ‡πâ‡∏Å 12‡∏ä‡∏µ‡πâ‡∏ô,65,0,0
2026-01-02,‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÄ‡∏Ñ‡πâ‡∏Å 24,120,0,0
2026-01-02,‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÄ‡∏Ñ‡πâ‡∏Å 36,100,0,0
2026-01-02,‡∏û‡∏£‡∏¥‡∏Å‡∏ó‡∏≠‡∏î,110,0,0
2026-01-02,‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ç‡∏¥‡∏á/‡πÅ‡∏Ñ‡∏£‡πå‡πÅ‡∏ö‡∏£‡πå,79,0,0
2026-01-02,‡∏ñ‡∏∏‡∏á‡∏ú‡πâ‡∏≤ nami,40,0,0
2026-01-02,‡πÅ‡∏Å‡πâ‡∏ß‡∏ô‡πâ‡∏≥‡∏ô‡∏≤‡∏°‡∏¥,0,0,0
2026-01-02,‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ü‡∏•‡∏Ñ,100,0,0
2026-01-02,‡∏≠‡∏∑‡πà‡∏ô‡πÜ,0,0,0
2026-01-02,cake pop,65,0,0
2026-01-02,‡∏Å‡∏∞‡∏ö‡∏≠‡∏Å‡∏ô‡πã‡∏≤,0,0,0
2026-01-02,cake orange,45,0,0"""

def get_current_sheet_name():
    """‡∏ä‡∏∑‡πà‡∏≠ Sheet ‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏õ‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô"""
    return datetime.now().strftime("%b_%Y")

conn = st.connection("gsheets", type=GSheetsConnection)

def load_data():
    current_sheet = get_current_sheet_name()
    try:
        df = conn.read(worksheet=current_sheet)
        if df.empty: raise ValueError("Empty sheet")
        df['Date'] = pd.to_datetime(df['Date']).dt.date
        return df
    except Exception:
        df = pd.read_csv(io.StringIO(INITIAL_CSV))
        df['Date'] = pd.to_datetime(df['Date'], errors='coerce').dt.date
        df = df.fillna(0)
        return df

# --- 2. ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• ---

st.set_page_config(page_title="‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ç‡∏≠‡∏á Cloud", layout="wide")

st.title("‚òÅÔ∏è ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô (Google Sheets)")
st.caption(f"Sheet ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: {get_current_sheet_name()}")
st.info("üí° ‡∏Ç‡πâ‡∏≠‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏¥‡πâ‡∏á‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏¢‡πÜ ‡∏Ñ‡∏£‡∏±‡∏ö")

if 'df' not in st.session_state:
    st.session_state.df = load_data()

# --- ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ---
st.subheader(f"üìù ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤")

# Data Editor
edited_df = st.data_editor(
    st.session_state.df,
    num_rows="dynamic",
    column_config={
        "Date": st.column_config.DateColumn("‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà", default=datetime.now().date(), format="YYYY-MM-DD"),
        "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£": st.column_config.TextColumn("‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤", required=True),
        "‡∏£‡∏≤‡∏Ñ‡∏≤": st.column_config.NumberColumn("‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏ä‡∏¥‡πâ‡∏ô", min_value=0, format="%.2f"),
        "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô/‡∏ä‡∏¥‡πâ‡∏ô": st.column_config.NumberColumn("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô", min_value=0, step=1),
        "‡∏£‡∏ß‡∏°/‡∏ö‡∏≤‡∏ó": st.column_config.NumberColumn("‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô", disabled=True) 
    },
    use_container_width=True,
    key="editor"
)

# --- üî• ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏à‡∏ö: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì + ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å + ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î üî• ---
if st.button("üíæ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô Cloud", type="primary"):
    with st.spinner('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...'):
        # 1. ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏∏‡∏Å‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î (‡∏Å‡∏±‡∏ô‡∏û‡∏•‡∏≤‡∏î)
        edited_df['‡∏£‡∏ß‡∏°/‡∏ö‡∏≤‡∏ó'] = edited_df['‡∏£‡∏≤‡∏Ñ‡∏≤'] * edited_df['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô/‡∏ä‡∏¥‡πâ‡∏ô']
        
        # 2. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤ Session
        st.session_state.df = edited_df
        
        # 3. ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏∂‡πâ‡∏ô Google Sheets
        conn.update(worksheet=get_current_sheet_name(), data=edited_df)
        
        st.success("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡πÅ‡∏•‡πâ‡∏ß")
        
        # 4. ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏™‡∏£‡∏∏‡∏õ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        st.rerun()

st.divider()

# --- ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î (Metrics) ---
st.subheader("üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (Real-time)")

# ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å edited_df (‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏î save ‡∏Å‡πá‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡πÄ‡∏£‡∏≤‡πÄ‡∏≠‡∏≤‡∏°‡∏≤‡πÇ‡∏ä‡∏ß‡πå‡∏Å‡πà‡∏≠‡∏ô)
# ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡∏Å‡∏î Save ‡πÅ‡∏•‡πâ‡∏ß ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Cloud ‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô
current_df = edited_df
today = datetime.now().date()

# ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
if not current_df.empty and '‡∏£‡∏ß‡∏°/‡∏ö‡∏≤‡∏ó' in current_df.columns:
    # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏î‡πÜ ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏î‡πâ‡∏ß‡∏¢ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏ß‡∏£‡πå‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
    current_df['‡∏£‡∏ß‡∏°/‡∏ö‡∏≤‡∏ó'] = current_df['‡∏£‡∏≤‡∏Ñ‡∏≤'] * current_df['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô/‡∏ä‡∏¥‡πâ‡∏ô']
    
    daily_sales = current_df[current_df['Date'] == today]['‡∏£‡∏ß‡∏°/‡∏ö‡∏≤‡∏ó'].sum()
    monthly_sales = current_df['‡∏£‡∏ß‡∏°/‡∏ö‡∏≤‡∏ó'].sum()
    items_today = current_df[current_df['Date'] == today]['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô/‡∏ä‡∏¥‡πâ‡∏ô'].sum()
else:
    daily_sales = 0
    monthly_sales = 0
    items_today = 0

col1, col2, col3 = st.columns(3)
col1.metric("‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (‡∏ö‡∏≤‡∏ó)", f"{daily_sales:,.2f}")
col2.metric("‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ (‡∏ö‡∏≤‡∏ó)", f"{monthly_sales:,.2f}")
col3.metric("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏¥‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ", f"{items_today:,.0f} ‡∏ä‡∏¥‡πâ‡∏ô")

st.divider()

# ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (Pivot Table)
st.subheader("üìÖ ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô")
if not current_df.empty and 'Date' in current_df.columns:
    summary_by_date = current_df.groupby('Date')[['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô/‡∏ä‡∏¥‡πâ‡∏ô', '‡∏£‡∏ß‡∏°/‡∏ö‡∏≤‡∏ó']].sum().sort_index(ascending=False)
    st.dataframe(summary_by_date)
